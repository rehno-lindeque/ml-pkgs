From 0d6f6f0f04e5eb05f0253580c78289bbb4a4c690 Mon Sep 17 00:00:00 2001
From: Rehno Lindeque <errantkid@gmail.com>
Date: Tue, 16 Aug 2022 10:05:28 -0400
Subject: [PATCH 1/3] torchdata-bin: init at 0.3.0

---
 .../python-modules/torchdata/bin.nix          | 69 +++++++++++++++++++
 pkgs/top-level/python-packages.nix            |  2 +
 2 files changed, 71 insertions(+)
 create mode 100644 pkgs/development/python-modules/torchdata/bin.nix

diff --git a/pkgs/development/python-modules/torchdata/bin.nix b/pkgs/development/python-modules/torchdata/bin.nix
new file mode 100644
index 0000000000000..1070be97e80d6
--- /dev/null
+++ b/pkgs/development/python-modules/torchdata/bin.nix
@@ -0,0 +1,69 @@
+{ lib
+, buildPythonPackage
+, fetchPypi
+, python
+, stdenv
+
+# Propagated build inputs
+, pytorch
+, requests
+
+# Python version
+, pythonOlder
+, pythonAtLeast
+}:
+
+let
+  srcs = {
+    "0.4.0" = {
+      "x86_64-linux-310" = {
+        platform = "manylinux2014_x86_64.whl";
+        sha256 = "sha256-6zBYHZ/06t0/m4MMKfzMMqnhse1zJ3aRWXL7SM37VHE=";
+      };
+    };
+    "0.4.1" = {
+      "x86_64-linux-310" = {
+        platform = "manylinux_2_17_x86_64.manylinux2014_x86_64";
+        sha256 = "sha256-HclqlVhvmab8cki6LqEIqfbKVVqoDMWDC8NKcgHpLyY=";
+      };
+    };
+  };
+  pyVerNoDot = lib.replaceStrings [ "." ] [ "" ] python.pythonVersion;
+  unsupported = throw "Unsupported system";
+in
+buildPythonPackage rec {
+  pname = "torchdata";
+  version = "0.3.0";
+  format = "wheel";
+
+  src =
+    if version == "0.3.0" then
+      fetchPypi {
+        inherit pname version format;
+        python = "py3";
+        dist = "py3";
+        sha256 = "sha256-vRb+N82aPcGWBQNVe11VYlHh8yuQeO2Ron3OUY6zKNY=";
+      }
+    else fetchPypi ({
+      inherit pname version format;
+      python = "cp${pyVerNoDot}";
+      abi = if pyVerNoDot == "37" then "cp${pyVerNoDot}m" else "cp${pyVerNoDot}";
+      dist = "cp${pyVerNoDot}";
+    } // srcs.${version}."${stdenv.system}-${pyVerNoDot}" or unsupported);
+
+  disabled = pythonOlder "3.7" || pythonAtLeast "3.11";
+
+  propagatedBuildInputs = [
+    pytorch
+    requests
+  ];
+
+  pythonImportsCheck = [ "torchdata" ];
+
+  meta = with lib; {
+    description = "A PyTorch repo for data loading and utilities to be shared by the PyTorch domain libraries.";
+    homepage = "github.com/pytorch/data";
+    license = licenses.bsd3;
+    maintainers = with maintainers; [  ];
+  };
+}
diff --git a/pkgs/top-level/python-packages.nix b/pkgs/top-level/python-packages.nix
index ec657aca004ed..f561c7b64623e 100644
--- a/pkgs/top-level/python-packages.nix
+++ b/pkgs/top-level/python-packages.nix
@@ -10826,6 +10826,8 @@ in {
 
   torchaudio-bin = callPackage ../development/python-modules/torchaudio/bin.nix { };
 
+  torchdata-bin = callPackage ../development/python-modules/torchdata/bin.nix { };
+
   torchgpipe = callPackage ../development/python-modules/torchgpipe { };
 
   torchmetrics = callPackage ../development/python-modules/torchmetrics { };

From 46fb58dc9eae5e73d4a42b9784bbdd507d44fa8b Mon Sep 17 00:00:00 2001
From: Rehno Lindeque <errantkid@gmail.com>
Date: Thu, 18 Aug 2022 18:01:11 -0400
Subject: [PATCH 2/3] torchdata-bin: 0.3.0 -> 0.4.1

---
 pkgs/development/python-modules/torchdata/bin.nix | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/pkgs/development/python-modules/torchdata/bin.nix b/pkgs/development/python-modules/torchdata/bin.nix
index 1070be97e80d6..9e573ff95690e 100644
--- a/pkgs/development/python-modules/torchdata/bin.nix
+++ b/pkgs/development/python-modules/torchdata/bin.nix
@@ -33,7 +33,7 @@ let
 in
 buildPythonPackage rec {
   pname = "torchdata";
-  version = "0.3.0";
+  version = "0.4.1";
   format = "wheel";
 
   src =

From 734af39e61488f7b26924210ea1caa2666b00fd3 Mon Sep 17 00:00:00 2001
From: Rehno Lindeque <errantkid@gmail.com>
Date: Sun, 21 Aug 2022 14:13:45 -0400
Subject: [PATCH 3/3] torchdata-bin: 0.3.0 -> 0.4.1 (with binary hashes)

---
 .../python-modules/torchdata/bin.nix          | 39 ++---------
 .../torchdata/binary-hashes.nix               | 66 +++++++++++++++++++
 .../python-modules/torchdata/prefetch.sh      | 47 +++++++++++++
 3 files changed, 120 insertions(+), 32 deletions(-)
 create mode 100644 pkgs/development/python-modules/torchdata/binary-hashes.nix
 create mode 100755 pkgs/development/python-modules/torchdata/prefetch.sh

diff --git a/pkgs/development/python-modules/torchdata/bin.nix b/pkgs/development/python-modules/torchdata/bin.nix
index 9e573ff95690e..bee5c82e19ab4 100644
--- a/pkgs/development/python-modules/torchdata/bin.nix
+++ b/pkgs/development/python-modules/torchdata/bin.nix
@@ -1,6 +1,6 @@
 { lib
 , buildPythonPackage
-, fetchPypi
+, fetchurl
 , python
 , stdenv
 
@@ -13,43 +13,18 @@
 , pythonAtLeast
 }:
 
-let
-  srcs = {
-    "0.4.0" = {
-      "x86_64-linux-310" = {
-        platform = "manylinux2014_x86_64.whl";
-        sha256 = "sha256-6zBYHZ/06t0/m4MMKfzMMqnhse1zJ3aRWXL7SM37VHE=";
-      };
-    };
-    "0.4.1" = {
-      "x86_64-linux-310" = {
-        platform = "manylinux_2_17_x86_64.manylinux2014_x86_64";
-        sha256 = "sha256-HclqlVhvmab8cki6LqEIqfbKVVqoDMWDC8NKcgHpLyY=";
-      };
-    };
-  };
-  pyVerNoDot = lib.replaceStrings [ "." ] [ "" ] python.pythonVersion;
-  unsupported = throw "Unsupported system";
-in
 buildPythonPackage rec {
   pname = "torchdata";
   version = "0.4.1";
   format = "wheel";
 
   src =
-    if version == "0.3.0" then
-      fetchPypi {
-        inherit pname version format;
-        python = "py3";
-        dist = "py3";
-        sha256 = "sha256-vRb+N82aPcGWBQNVe11VYlHh8yuQeO2Ron3OUY6zKNY=";
-      }
-    else fetchPypi ({
-      inherit pname version format;
-      python = "cp${pyVerNoDot}";
-      abi = if pyVerNoDot == "37" then "cp${pyVerNoDot}m" else "cp${pyVerNoDot}";
-      dist = "cp${pyVerNoDot}";
-    } // srcs.${version}."${stdenv.system}-${pyVerNoDot}" or unsupported);
+    let
+      pyVerNoDot = lib.replaceStrings [ "." ] [ "" ] python.pythonVersion;
+      unsupported = throw "Unsupported system ${stdenv.system}-${pyVerNoDot}";
+      srcUrl = (import ./binary-hashes.nix version)."${stdenv.system}-${pyVerNoDot}" or unsupported;
+    in
+      fetchurl srcUrl;
 
   disabled = pythonOlder "3.7" || pythonAtLeast "3.11";
 
diff --git a/pkgs/development/python-modules/torchdata/binary-hashes.nix b/pkgs/development/python-modules/torchdata/binary-hashes.nix
new file mode 100644
index 0000000000000..4ad6f48eb2cdf
--- /dev/null
+++ b/pkgs/development/python-modules/torchdata/binary-hashes.nix
@@ -0,0 +1,66 @@
+# Warning: Need to update at the same time as pytorch-bin
+#
+# Precompiled wheels can be found at:
+# https://pypi.org/project/torchdata/#files
+
+# To add a new version, run "prefetch.sh 'new-version'" to paste the generated file as follows.
+
+version : builtins.getAttr version {
+  "0.4.1" = {
+    x86_64-linux-37 = {
+      name = "torchdata-0.4.1-cp37-cp37m-linux_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp37/t/torchdata/torchdata-0.4.1-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl";
+      hash = "sha256-RCuu0lDggkX/9JLTYtefjbZ5bvzbbrXsXzFnqGDwqGs=";
+    };
+    x86_64-linux-38 = {
+      name = "torchdata-0.4.1-cp38-cp38-linux_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp38/t/torchdata/torchdata-0.4.1-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl";
+      hash = "sha256-+rqP6uZo2fK9klNIAkqui3n3TBhcmQCPX0xN5a587mc=";
+    };
+    x86_64-linux-39 = {
+      name = "torchdata-0.4.1-cp39-cp39-linux_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp39/t/torchdata/torchdata-0.4.1-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl";
+      hash = "sha256-QEhKqs1+rz56bwRkSyMjjKVgu0mf4ta2x20UguY00DM=";
+    };
+    x86_64-linux-310 = {
+      name = "torchdata-0.4.1-cp310-cp310-linux_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp310/t/torchdata/torchdata-0.4.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl";
+      hash = "sha256-HclqlVhvmab8cki6LqEIqfbKVVqoDMWDC8NKcgHpLyY=";
+    };
+    x86_64-darwin-37 = {
+      name = "torchdata-0.4.1-cp37-cp37m-macosx_10_13_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp37/t/torchdata/torchdata-0.4.1-cp37-cp37m-macosx_10_13_x86_64.whl";
+      hash = "sha256-y0Aa8c0nAi5//goXOy9Fpvv4Ff+mHYKkthd4T6I3Ep4=";
+    };
+    x86_64-darwin-38 = {
+      name = "torchdata-0.4.1-cp38-cp38-macosx_10_13_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp38/t/torchdata/torchdata-0.4.1-cp38-cp38-macosx_10_13_x86_64.whl";
+      hash = "sha256-wJLjKzYg/FpjOcTkx43wdASo3RpSrl8kiboSANgYfrM=";
+    };
+    x86_64-darwin-39 = {
+      name = "torchdata-0.4.1-cp39-cp39-macosx_10_13_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp39/t/torchdata/torchdata-0.4.1-cp39-cp39-macosx_10_13_x86_64.whl";
+      hash = "sha256-RFzqXYoiHaXFlZ27GtftA08h0iOlggovhnYZGjnd6ZY=";
+    };
+    x86_64-darwin-310 = {
+      name = "torchdata-0.4.1-cp310-cp310-macosx_10_13_x86_64.whl";
+      url = "https://files.pythonhosted.org/packages/cp310/t/torchdata/torchdata-0.4.1-cp310-cp310-macosx_10_13_x86_64.whl";
+      hash = "sha256-zwmN/906LWrgxIxP7Fg3IemxwgviWrQB4AeFJqd9mVo=";
+    };
+    aarch64-darwin-38 = {
+      name = "torchdata-0.4.1-cp38-cp38-macosx_11_0_arm64.whl";
+      url = "https://files.pythonhosted.org/packages/cp38/t/torchdata/torchdata-0.4.1-cp38-cp38-macosx_11_0_arm64.whl";
+      hash = "sha256-9V6TU3qVE+D1oj/kvRQmL80w4+3XUaOO+GuuQ1rmtHk=";
+    };
+    aarch64-darwin-39 = {
+      name = "torchdata-0.4.1-cp39-cp39-macosx_11_0_arm64.whl";
+      url = "https://files.pythonhosted.org/packages/cp39/t/torchdata/torchdata-0.4.1-cp39-cp39-macosx_11_0_arm64.whl";
+      hash = "sha256-Mqy1eKfQGj07ou2upiG/NTT2pFGKOfyYKoXYLiW2n/c=";
+    };
+    aarch64-darwin-310 = {
+      name = "torchdata-0.4.1-cp310-cp310-macosx_11_0_arm64.whl";
+      url = "https://files.pythonhosted.org/packages/cp310/t/torchdata/torchdata-0.4.1-cp310-cp310-macosx_11_0_arm64.whl";
+      hash = "sha256-mVcnqbWHF54mHkUUR7sdVvlbtahdP7AR24895+GHRmw=";
+    };
+  };
+}
diff --git a/pkgs/development/python-modules/torchdata/prefetch.sh b/pkgs/development/python-modules/torchdata/prefetch.sh
new file mode 100755
index 0000000000000..7dc9408610e5a
--- /dev/null
+++ b/pkgs/development/python-modules/torchdata/prefetch.sh
@@ -0,0 +1,47 @@
+#!/usr/bin/env nix-shell
+#!nix-shell -i bash -p nix-prefetch-scripts
+
+set -eou pipefail
+
+version=$1
+
+bucket="https://files.pythonhosted.org/packages"
+
+url_and_key_list=(
+  "x86_64-linux-37 $bucket/cp37/t/torchdata/torchdata-${version}-cp37-cp37m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl torchdata-${version}-cp37-cp37m-linux_x86_64.whl"
+  "x86_64-linux-38 $bucket/cp38/t/torchdata/torchdata-${version}-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl torchdata-${version}-cp38-cp38-linux_x86_64.whl"
+  "x86_64-linux-39 $bucket/cp39/t/torchdata/torchdata-${version}-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl torchdata-${version}-cp39-cp39-linux_x86_64.whl"
+  "x86_64-linux-310 $bucket/cp310/t/torchdata/torchdata-${version}-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl torchdata-${version}-cp310-cp310-linux_x86_64.whl"
+
+  "x86_64-darwin-37 $bucket/cp37/t/torchdata/torchdata-${version}-cp37-cp37m-macosx_10_13_x86_64.whl torchdata-${version}-cp37-cp37m-macosx_10_13_x86_64.whl"
+  "x86_64-darwin-38 $bucket/cp38/t/torchdata/torchdata-${version}-cp38-cp38-macosx_10_13_x86_64.whl torchdata-${version}-cp38-cp38-macosx_10_13_x86_64.whl"
+  "x86_64-darwin-39 $bucket/cp39/t/torchdata/torchdata-${version}-cp39-cp39-macosx_10_13_x86_64.whl torchdata-${version}-cp39-cp39-macosx_10_13_x86_64.whl"
+  "x86_64-darwin-310 $bucket/cp310/t/torchdata/torchdata-${version}-cp310-cp310-macosx_10_13_x86_64.whl torchdata-${version}-cp310-cp310-macosx_10_13_x86_64.whl"
+
+  "aarch64-darwin-38 $bucket/cp38/t/torchdata/torchdata-${version}-cp38-cp38-macosx_11_0_arm64.whl torchdata-${version}-cp38-cp38-macosx_11_0_arm64.whl"
+  "aarch64-darwin-39 $bucket/cp39/t/torchdata/torchdata-${version}-cp39-cp39-macosx_11_0_arm64.whl torchdata-${version}-cp39-cp39-macosx_11_0_arm64.whl"
+  "aarch64-darwin-310 $bucket/cp310/t/torchdata/torchdata-${version}-cp310-cp310-macosx_11_0_arm64.whl torchdata-${version}-cp310-cp310-macosx_11_0_arm64.whl"
+)
+
+hashfile=binary-hashes-"$version".nix
+echo "  \"$version\" = {" >> $hashfile
+
+for url_and_key in "${url_and_key_list[@]}"; do
+  key=$(echo "$url_and_key" | cut -d' ' -f1)
+  url=$(echo "$url_and_key" | cut -d' ' -f2)
+  name=$(echo "$url_and_key" | cut -d' ' -f3)
+
+  echo "prefetching ${url}..."
+  hash=$(nix hash to-sri --type sha256 `nix-prefetch-url "$url" --name "$name"`)
+
+  echo "    $key = {" >> $hashfile
+  echo "      name = \"$name\";" >> $hashfile
+  echo "      url = \"$url\";" >> $hashfile
+  echo "      hash = \"$hash\";" >> $hashfile
+  echo "    };" >> $hashfile
+
+  echo
+done
+
+echo "  };" >> $hashfile
+echo "done."
